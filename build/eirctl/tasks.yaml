tasks:
  build:number:
    context: powershell
    description: Update the build number
    # Note:
    # - The legacy `exportAs` field for this task has been intentionally removed.
    # - The build number is updated directly by `Update-BuildNumber`, so no additional
    #   environment export from this task is required.
    command:
      - Update-BuildNumber

  lint:yaml:
    context: powershell
    description: Perform YAML linting
    command:
      - Invoke-YamlLint

  lint:terraform:format:
    context: powershell
    description: Perform Terraform format check
    command:
      - Invoke-Terraform -Format -Path $env:TF_FILE_LOCATION

  lint:terraform:validate:
    context: powershell
    description: Perform Terraform validation
    command:
      - Invoke-Terraform -Validate -Path $env:TF_FILE_LOCATION

  infra:init:
    context: powershell
    description: Initialise Terraform for chosen templates
    command:
      - Invoke-Terraform -Init -Path $env:TF_FILE_LOCATION -Arguments $env:TF_BACKEND_INIT -debug
      - Invoke-Terraform -Workspace -Arguments $env:TF_VAR_stage -Path $env:TF_FILE_LOCATION

  infra:vars:
    context: powershell
    description: Create Terraform variables file
    command:
      - /eirctl/build/scripts/Set-TFVars.ps1 | Out-File -Path "${env:TF_FILE_LOCATION}/terraform.tfvars"
      - dir ${env:TF_FILE_LOCATION}

  infra:plan:
    context: powershell
    description: Plan Terraform
    command:
      - Invoke-Terraform -Plan -Path $env:TF_FILE_LOCATION -Arguments "-input=false","-out=`"deploy.tfplan`""

  infra:apply:
    context: powershell
    description: Apply Terraform
    command:
      - Invoke-Terraform -Apply -Path "${env:TF_FILE_LOCATION}/deploy.tfplan"

  infra:destroy:plan:
    context: powershell
    description: Destroy Environment.ShortName
    command:
      - Invoke-Terraform -Plan -Path $env:TF_FILE_LOCATION -Arguments "-destroy,-input=false,-out=`"destroy.tfplan`"" -debug

  infra:destroy:apply:
    context: powershell
    description: Destroy Environment.ShortName
    command:
      - Invoke-Terraform -Apply -Path "${env:TF_FILE_LOCATION}/destroy.tfplan" -Arguments "-destroy" -debug

  infra:output:
    context: powershell
    description: Terraform Outputs
    command:
      - Invoke-Terraform -Output -Path $env:TF_FILE_LOCATION | Out-File local/output.json

  setup:dev:
    context: powershell
    description: Create a shell script to configure the environment variables
    command:
      - New-Item -Type directory /eirctl/local -ErrorAction SilentlyContinue
      - New-EnvConfig -Path /eirctl/build/config/stage_envvars.yml -ScriptPath /eirctl/local -Cloud azure -Stage dev

  setup:environment:
    context: powershell
    description: Ensure that the environment is configured correctly
    command:
      - Confirm-Environment -Path /eirctl/build/config/stage_envvars.yml

  setup:validate:azdo:pat:
    context: powershell
    description: Validate Azure DevOps PAT has required scopes for variable group creation
    command:
      - /eirctl/build/scripts/Test-AzureDevOpsPAT.ps1

  tests:infra:init:
    context: infratests
    description: Initialise the Inspec test profile
    env:
      CHEF_LICENSE: accept-silent
    command:
      - |
        Import-Module -Name EnsonoBuild -ErrorAction Stop
        Invoke-Inspec -path /eirctl/deploy/tests -init

  tests:infra:vendor:
    context: infratests
    description: Ensure all necessary plugins and providers are installed
    env:
      CHEF_LICENSE: accept-silent
    command:
      - |
        Import-Module -Name EnsonoBuild -ErrorAction Stop
        Invoke-Inspec -path /eirctl/deploy/tests -vendor -arguments "--overwrite"

  tests:infra:inputs:
    context: powershell
    description: Create file to use as the input for the Inspec tests
    command:
      - |
        # Default TF_FILE_LOCATION to conventional path if not set
        if ([string]::IsNullOrEmpty($env:TF_FILE_LOCATION)) {
            $env:TF_FILE_LOCATION = '/eirctl/deploy/terraform'
            Write-Warning "TF_FILE_LOCATION not set, defaulting to: $($env:TF_FILE_LOCATION)"
        }

        # Fail-fast validation for required environment variables
        $requiredVars = @('TF_VAR_stage', 'TF_VAR_location', 'ARM_CLIENT_ID', 'ARM_CLIENT_SECRET', 'ARM_TENANT_ID', 'ARM_SUBSCRIPTION_ID')
        $missing = $requiredVars | Where-Object { [string]::IsNullOrEmpty([Environment]::GetEnvironmentVariable($_)) }
        if ($missing.Count -gt 0) {
            Write-Error "Missing required environment variables: $($missing -join ', '). Run 'source ./local/envvar-azure-dev.sh' or set these variables before running tests."
            exit 1
        }

        Import-Module Az.Aks
        Import-Module Az.KeyVault -ErrorAction SilentlyContinue
        Invoke-Terraform -Workspace -Arguments $env:TF_VAR_stage -Path $env:TF_FILE_LOCATION
        Invoke-Terraform -Output -Path $env:TF_FILE_LOCATION | /eirctl/build/scripts/Set-EnvironmentVars.ps1 -prefix "TFOUT" -key "value" -passthru | ConvertTo-Yaml | Out-File -Path /eirctl/inspec_inputs.yml
        Get-AzureServiceVersions -service aks -client_id $env:ARM_CLIENT_ID -client_password $env:ARM_CLIENT_SECRET -tenant_id $env:ARM_TENANT_ID -location $env:TF_VAR_location | ConvertTo-Yaml | Out-File -Path /eirctl/inspec_inputs.yml -Append
        Add-Content -Path /eirctl/inspec_inputs.yml -Value "region: $($env:TF_VAR_location)"
        Add-Content -Path /eirctl/inspec_inputs.yml -Value "kubernetes_private_cluster: $($env:TF_VAR_is_cluster_private)"
        Add-Content -Path /eirctl/inspec_inputs.yml -Value "subscription_id: $($env:ARM_SUBSCRIPTION_ID)"
        Add-Content -Path /eirctl/inspec_inputs.yml -Value "azure_application_id: $($env:ARM_CLIENT_ID)"

        $nodePools = @{}
        if ($env:TF_VAR_aks_node_pools -and $env:TF_VAR_aks_node_pools.Trim() -ne "" -and $env:TF_VAR_aks_node_pools.Trim() -ne "{}") {
          $nodePools = $env:TF_VAR_aks_node_pools | ConvertFrom-Json
        }
        $additionalPoolCount = 0
        if ($nodePools -is [System.Collections.IDictionary]) {
          $additionalPoolCount = $nodePools.Keys.Count
        }
        elseif ($nodePools -is [System.Array]) {
          $additionalPoolCount = $nodePools.Count
        }
        else {
          $additionalPoolCount = $nodePools.PSObject.Properties.Count
        }
        $nodePoolCount = 1 + [int]$additionalPoolCount
        Add-Content -Path /eirctl/inspec_inputs.yml -Value "node_pool_count: $nodePoolCount"

        $publicIpSku = "Standard"
        if ($env:TFOUT_app_gateway_public_ip_name -and $env:TFOUT_app_gateway_resource_group_name) {
            $publicIp = Get-AzPublicIpAddress -Name $env:TFOUT_app_gateway_public_ip_name -ResourceGroupName $env:TFOUT_app_gateway_resource_group_name -ErrorAction SilentlyContinue
            if ($publicIp -and $publicIp.Sku -and $publicIp.Sku.Name) {
                $publicIpSku = $publicIp.Sku.Name
            }
        }
        Add-Content -Path /eirctl/inspec_inputs.yml -Value "public_ip_sku: $publicIpSku"

        $keyVaults = @()
        if ($env:TFOUT_resource_group_name) {
          $keyVaultsRaw = Get-AzKeyVault -ResourceGroupName $env:TFOUT_resource_group_name -ErrorAction SilentlyContinue
          foreach ($kv in @($keyVaultsRaw)) {
            $skuName = $kv.Sku.Name
            if (-not $skuName) {
              $skuName = "standard"
            }
            $keyVaults += [pscustomobject]@{
              name = $kv.VaultName
              sku  = $skuName
            }
          }
        }
        @{ key_vault = @($keyVaults) } | ConvertTo-Yaml | Out-File -Path /eirctl/inspec_inputs.yml -Append

  tests:infra:run:
    context: infratests
    description: Execute infrastructure tests against deployed Cloud resources
    env:
      CHEF_LICENSE: accept-silent
      AZURE_CLIENT_ID: ${ARM_CLIENT_ID}
      AZURE_CLIENT_SECRET: ${ARM_CLIENT_SECRET}
      AZURE_TENANT_ID: ${ARM_TENANT_ID}
      AZURE_SUBSCRIPTION_ID: ${ARM_SUBSCRIPTION_ID}
    command:
      - |
        $env:AZURE_CLIENT_ID = $env:ARM_CLIENT_ID
        $env:AZURE_CLIENT_SECRET = $env:ARM_CLIENT_SECRET
        $env:AZURE_TENANT_ID = $env:ARM_TENANT_ID
        $env:AZURE_SUBSCRIPTION_ID = $env:ARM_SUBSCRIPTION_ID
        Import-Module -Name EnsonoBuild -ErrorAction Stop
        Invoke-Inspec -path /eirctl/deploy/tests -execute -arguments "--input-file=/eirctl/inspec_inputs.yml"

  infra:state:lock:clear:
    context: powershell
    description: Clear Terraform state lock from Azure Storage backend
    command:
      - /eirctl/build/scripts/Clear-TerraformStateLock.ps1 `
          -StorageAccountName $env:TF_STATE_STORAGE `
          -ContainerName $env:TF_STATE_CONTAINER `
          -StateKey $env:TF_STATE_KEY `
          -ResourceGroupName $env:TF_STATE_RG

  infra:helm:apply:
    context: powershell
    description: Deploy Helm charts to the cluster as defined by configuration file
    command:
      - |
        $ErrorActionPreference = "Stop"

        Import-Module Az.Aks

        Invoke-Terraform -Output -Path $env:TF_FILE_LOCATION | /eirctl/build/scripts/Set-EnvironmentVars.ps1 -prefix "TFOUT" -key "value"

        /eirctl/build/scripts/Deploy-HelmCharts.ps1 `
          -Path /eirctl/deploy/helm/k8s_apps.yaml `
          -ResourceGroup ${env:TFOUT_resource_group_name} `
          -Clustername ${env:TFOUT_aks_cluster_name} `
          -Provider ${env:CLOUD_PLATFORM}

  _docs:
    description: Build Docs for AKS
    context: docs
    command: |
      /eirctl/build/scripts/New-Glossary.ps1 -docpath /eirctl/docs -path /eirctl/tmp/glossary.adoc
      Build-Documentation -Config /eirctl/docs.json -BasePath /eirctl -Verbose

  _release:
    context: powershell
    command:
      - Publish-GitHubRelease `
          -version $env:BUILD_BUILDNUMBER `
          -commitId $env:COMMIT_ID `
          -apikey $env:GITHUB_TOKEN `
          -artifactsDir $env:ARTIFACTS_DIR `
          -Owner $env:OWNER `
          -repository $env:REPOSITORY
