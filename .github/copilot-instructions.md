# Ensono Stacks - AKS Infrastructure

This repository deploys production Azure Kubernetes Service (AKS) clusters using Terraform and Helm, orchestrated via eirctl and Azure DevOps pipelines.

## Architecture Overview

**Core Components:**

- Terraform modules ([deploy/terraform/](../deploy/terraform/)) provision AKS, ACR, Key Vault, VNets, and DNS zones via the Ensono Stacks Terraform library (v4.0.6+)
- Helm charts ([deploy/helm/](../deploy/helm/)) deploy cluster add-ons: ingress-nginx, external-dns, kured, AAD pod identity
- InSpec tests ([deploy/tests/](../deploy/tests/)) validate deployed infrastructure state against expected configurations
- PowerShell automation scripts ([build/scripts/](../build/scripts/)) bridge Azure DevOps, eirctl, and infrastructure tools

**Key Design Pattern:**
All resources use a predictable naming convention via `cloudposse/terraform-null-label` module: `{company}-{project}-{stage}-{location}-{component}` (e.g., `acme-myapp-dev-eun-aks`). Region shortcodes are defined in [deploy/terraform/locals.tf](../deploy/terraform/locals.tf#L4-L14).

## Critical Workflows

### Local Development

Use `eirctl` to run operations locally via Docker containers:

```bash
# Lint all code
eirctl run lint

# Deploy infrastructure (requires envfile with Azure credentials)
eirctl run infrastructure

# Run infrastructure tests
eirctl run tests
```

**Important:** Commands execute in PowerShell containers defined in [build/eirctl/contexts.yaml](../build/eirctl/contexts.yaml). The contexts mount `/var/run/docker.sock` to enable nested Docker operations and require an `envfile` with Azure credentials (excluded from Git).

### Environment Variable Management

Terraform variables MUST be prefixed with `TF_VAR_*` and exported to the environment. The [build/scripts/Set-TFVars.ps1](../build/scripts/Set-TFVars.ps1) script converts these to `terraform.tfvars` format automatically during the `infra:vars` task.

Required variables are documented in [build/config/stage_envvars.yml](../build/config/stage_envvars.yml). Use `eirctl run setup:dev` to generate a shell script for local development.

### Terraform State Management

- Backend configuration via `TF_BACKEND_INIT` (init args) and `TF_BACKEND_PLAN` (plan args) environment variables
- Workspaces correspond to `TF_VAR_name_environment` (set during `infra:init`)
- Plans are saved as `deploy.tfplan` or `destroy.tfplan` and applied in subsequent steps

### Azure DevOps Pipeline

[build/azDevOps/azure/deploy-infrastructure.yml](../build/azDevOps/azure/deploy-infrastructure.yml) orchestrates multi-stage deployments:

1. Lint (YAML + Terraform format/validate)
2. Infrastructure deployment (init → plan → apply)
3. Helm chart deployment via [build/scripts/Deploy-HelmCharts.ps1](../build/scripts/Deploy-HelmCharts.ps1)
4. InSpec validation tests

Parameters control deploy/destroy behavior and support feature branch pre-releases.

## Project-Specific Conventions

### Terraform Module Sourcing

The project depends on `github.com/Ensono/stacks-terraform` modules. When updating module versions:

- Pin specific git refs in [deploy/terraform/aks.tf](../deploy/terraform/aks.tf#L2) (e.g., `?ref=v4.0.6`)
- Review module changelog for breaking changes to input variables

### Helm Chart Configuration

Charts are defined in [deploy/helm/k8s_apps.yaml](../deploy/helm/k8s_apps.yaml) with an `enabled` flag controlling deployment. Values templates in [deploy/helm/values/](../deploy/helm/values/) use Go templating with environment variable substitution by the PowerShell deployment script.

**Critical:** Some charts (e.g., `cluster-setup`) are in-repo at [deploy/helm/charts/](../deploy/helm/charts/), while others reference external repos. The `Deploy-HelmCharts.ps1` script handles both patterns.

### Testing Patterns

InSpec controls ([deploy/tests/controls/](../deploy/tests/controls/)) validate:

- Resource existence and provisioning state
- AKS configuration (RBAC enabled, node pool counts, identity type)
- Tagging compliance and naming conventions

Tests receive inputs via attributes file generated by `tests:infra:inputs` task (references Terraform outputs).

## Common Operations

**Add a new Terraform variable:**

1. Define in [deploy/terraform/variables.tf](../deploy/terraform/variables.tf)
2. Add to [build/config/stage_envvars.yml](../build/config/stage_envvars.yml) with `TF_VAR_` prefix
3. Pass to module in [deploy/terraform/aks.tf](../deploy/terraform/aks.tf)
4. Update [build/azDevOps/azure/pipeline-vars.yml](../build/azDevOps/azure/pipeline-vars.yml) for CI/CD

**Add a Helm chart:**

1. Append entry to [deploy/helm/k8s_apps.yaml](../deploy/helm/k8s_apps.yaml)
2. Create values template in [deploy/helm/values/](../deploy/helm/values/)
3. Set `enabled: true` and specify `namespace`, `repo`, `version`

**Modify resource naming:**

1. Adjust module inputs in [deploy/terraform/label.tf](../deploy/terraform/label.tf) (namespace, stage, name format)
2. Update location shortcodes in [deploy/terraform/locals.tf](../deploy/terraform/locals.tf) if adding regions

## Documentation

Full documentation is in [docs/](../docs/) and built via AsciiDoc. Run `eirctl run docs` to generate HTML output using custom Ensono themes ([docs/styles/](../docs/styles/)).
